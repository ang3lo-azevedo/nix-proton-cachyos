name: Update Package Version

on:
 schedule:
   - cron: '0 0 * * *'  # Run every day at midnight
 workflow_dispatch:

permissions:
 contents: write
 pull-requests: write

jobs:
 check-update:
   runs-on: ubuntu-latest
   steps:
     - uses: actions/checkout@v4

     - name: Install Nix
       uses: cachix/install-nix-action@v25
       with:
         github_access_token: ${{ secrets.GITHUB_TOKEN }}

     - name: Check for Updates
       id: check
       run: |
         # 1. Handle missing versions.json gracefully
         if [ -f versions.json ]; then
           OLD_CONTENT=$(cat versions.json | tr -d '[:space:]')
         else
           OLD_CONTENT="none"
         fi

         # 2. Get latest version info
         # We extract the full filename first
         LATEST_FILE=$(curl -s 'https://mirror.cachyos.org/repo/x86_64_v3/cachyos-v3/' | grep -Po 'proton-cachyos-1:\d+\.\d+\.\d+-\d+-x86_64_v3\.pkg\.tar\.zst' | sort -V | tail -n1)
         
         if [ -z "$LATEST_FILE" ]; then
           echo "Failed to find package on mirror"
           exit 1
         fi

         # Encode for URL: replace ':' with '%3A'
         ENCODED_FILE=${LATEST_FILE//:/%3A}
         
         # Extract Base (e.g., 9.0.20250126) and Release (e.g., 2)
         # Note: Adjusting regex to match your Nix URL logic
         BASE=$(echo $LATEST_FILE | grep -Po '(?<=:)\d+\.\d+\.\d+')
         RELEASE=$(echo $LATEST_FILE | grep -Po '(?<=\d-)\d+(?=-x86_64)')

         # 3. Download and Hash
         TEMP_FILE=$(mktemp)
         curl -L "https://mirror.cachyos.org/repo/x86_64_v3/cachyos-v3/${ENCODED_FILE}" -o "$TEMP_FILE"
         HASH=$(nix hash file --base64 --type sha256 "$TEMP_FILE")
         rm "$TEMP_FILE"

         # 4. Construct JSON (formatted as a single line for easy comparison)
         NEW_CONTENT="{\"base\":\"$BASE\",\"release\":\"$RELEASE\",\"hash\":\"sha256-$HASH\"}"

         # 5. Compare and Save
         if [ "$OLD_CONTENT" = "$NEW_CONTENT" ]; then
           echo "No updates available"
           echo "UPDATE_NEEDED=false" >> $GITHUB_ENV
         else
           # Save formatted JSON
           echo "{\"base\": \"$BASE\", \"release\": \"$RELEASE\", \"hash\": \"sha256-$HASH\"}" > versions.json
           echo "UPDATE_NEEDED=true" >> $GITHUB_ENV
         fi

     - name: Create Pull Request
       if: env.UPDATE_NEEDED == 'true'
       uses: peter-evans/create-pull-request@v5
       with:
         token: ${{ secrets.GITHUB_TOKEN }}
         commit-message: 'proton-cachyos: update to latest version'
         title: 'Update proton-cachyos'
         body: |
           Updated proton-cachyos to latest version from CachyOS mirror.

           This PR was created automatically by the update workflow.
         branch: update-proton-cachyos
         delete-branch: true
