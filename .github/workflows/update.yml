name: Update Package Version

on:
 schedule:
   - cron: '0 0 * * *'  # Run every day at midnight
 workflow_dispatch:

permissions:
 contents: write
 pull-requests: write

jobs:
 check-update:
   runs-on: ubuntu-latest
   steps:
     - uses: actions/checkout@v4

     - name: Install Nix
       uses: cachix/install-nix-action@v25
       with:
         github_access_token: ${{ secrets.GITHUB_TOKEN }}

     - name: Check for Updates
       id: check
       run: |
         # Read current version
         [ -f versions.json ] && OLD_CONTENT=$(cat versions.json | tr -d '[:space:]') || OLD_CONTENT=""

         # 1. Get the full filename from the mirror
         # Example: proton-cachyos-1:9.0.20250126-2-x86_64_v3.pkg.tar.zst
         FULL_NAME=$(curl -s 'https://mirror.cachyos.org/repo/x86_64_v3/cachyos-v3/' | grep -Po 'proton-cachyos-1:\d+\.\d+\.\d+-\d+-x86_64_v3\.pkg\.tar\.zst' | sort -V | tail -n1)
         
         if [ -z "$FULL_NAME" ]; then exit 1; fi

         # 2. Extract parts
         # BASE will be "9.0"
         BASE=$(echo $FULL_NAME | grep -Po '(?<=:)\d+\.\d+')
         # RELEASE will be "20250126" (the part after the second dot)
         RELEASE=$(echo $FULL_NAME | grep -Po '(?<=\d\.)\d+(?=-\d+-x86_64)')
         
         ENCODED_NAME=${FULL_NAME//:/%3A}

         # 3. Verify Download and Hash
         TEMP_FILE=$(mktemp)
         curl -Lf "https://mirror.cachyos.org/repo/x86_64_v3/cachyos-v3/${ENCODED_NAME}" -o "$TEMP_FILE"
         HASH=$(nix hash file --base64 --type sha256 "$TEMP_FILE")
         rm "$TEMP_FILE"

         # 4. Save
         NEW_JSON="{\"base\":\"$BASE\",\"release\":\"$RELEASE\",\"hash\":\"sha256-$HASH\"}"
         
         if [ "$OLD_CONTENT" = "$NEW_JSON" ]; then
           echo "UPDATE_NEEDED=false" >> $GITHUB_ENV
         else
           echo "{\"base\": \"$BASE\", \"release\": \"$RELEASE\", \"hash\": \"sha256-$HASH\"}" > versions.json
           echo "UPDATE_NEEDED=true" >> $GITHUB_ENV
         fi

     - name: Create Pull Request
       if: env.UPDATE_NEEDED == 'true'
       uses: peter-evans/create-pull-request@v5
       with:
         token: ${{ secrets.GITHUB_TOKEN }}
         commit-message: 'proton-cachyos: update to latest version'
         title: 'Update proton-cachyos'
         body: |
           Updated proton-cachyos to latest version from CachyOS mirror.

           This PR was created automatically by the update workflow.
         branch: update-proton-cachyos
         delete-branch: true
