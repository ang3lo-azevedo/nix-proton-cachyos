name: Update Package Version

on:
 schedule:
   - cron: '0 0 * * *'  # Run every day at midnight
 workflow_dispatch:

permissions:
 contents: write
 pull-requests: write

jobs:
 check-update:
   runs-on: ubuntu-latest
   steps:
     - uses: actions/checkout@v4

     - name: Install Nix
       uses: cachix/install-nix-action@v25
       with:
         github_access_token: ${{ secrets.GITHUB_TOKEN }}

     - name: Check for Updates
       id: check
       run: |
         # 1. Safely read old content
         [ -f versions.json ] && OLD_CONTENT=$(cat versions.json) || OLD_CONTENT=""
 
         # 2. Get LATEST (CachyOS uses a colon in the filename)
         LATEST=$(curl -s 'https://mirror.cachyos.org/repo/x86_64_v3/cachyos-v3/' | grep -Po 'proton-cachyos-1:\d+\.\d+\.\d+-\d+-x86_64_v3\.pkg\.tar\.zst' | sort -V | tail -n1)
         
         if [ -z "$LATEST" ]; then
           echo "Error: Mirror might be down or pattern changed."
           exit 1
         fi
 
         # Encode the colon for the URL download
         ENCODED_LATEST=${LATEST//:/%3A}
         
         # Extract parts for JSON
         BASE=$(echo $LATEST | grep -Po '(?<=:)\d+\.\d+(?=\.)')
         RELEASE=$(echo $LATEST | grep -Po '\d+(?=-\d+-x86_64)')
 
         # 3. Download to verify it exists before saving
         TEMP_FILE=$(mktemp)
         if ! curl -Lf "https://mirror.cachyos.org/repo/x86_64_v3/cachyos-v3/${ENCODED_LATEST}" -o "$TEMP_FILE"; then
           echo "Download failed (404). Mirror is likely mid-update. Skipping."
           exit 0
         fi
 
         HASH=$(nix hash file --base64 --type sha256 "$TEMP_FILE")
         rm "$TEMP_FILE"
 
         # 4. Create NEW_CONTENT (Single line for safety)
         NEW_CONTENT="{\"base\": \"$BASE\", \"release\": \"$RELEASE\", \"hash\": \"sha256-$HASH\"}"
 
         # 5. Compare and Update
         if [ "$(echo $OLD_CONTENT | tr -d '[:space:]')" = "$(echo $NEW_CONTENT | tr -d '[:space:]')" ]; then
           echo "No updates available."
           echo "UPDATE_NEEDED=false" >> $GITHUB_ENV
         else
           echo "$NEW_CONTENT" > versions.json
           echo "UPDATE_NEEDED=true" >> $GITHUB_ENV
         fi

     - name: Create Pull Request
       if: env.UPDATE_NEEDED == 'true'
       uses: peter-evans/create-pull-request@v5
       with:
         token: ${{ secrets.GITHUB_TOKEN }}
         commit-message: 'proton-cachyos: update to latest version'
         title: 'Update proton-cachyos'
         body: |
           Updated proton-cachyos to latest version from CachyOS mirror.

           This PR was created automatically by the update workflow.
         branch: update-proton-cachyos
         delete-branch: true
